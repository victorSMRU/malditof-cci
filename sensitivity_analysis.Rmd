---
title: "Sensitivity analysis"
author: "Victor Chaumeau"
date: "2024-05-01"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(cache = TRUE, cache.comments = FALSE, echo = FALSE,
                      include = TRUE, cache.lazy = FALSE)

# Load packages
library(data.table)
library(MALDIquant)
library(MALDIquantForeign)

# Load custom functions
source("code/cci_algorithm.R")
source("code/function_reproducibility.R")

# Declare environment variables
MAKE_MSL = FALSE
PANEL_TO_BANK = FALSE
RUN_SIM = FALSE

```

# Session information

```{r session_info}

sessionInfo()

```

```{r import_dataset}

load("Rdata/taxonomy.Rdata")
load("Rdata/metadata.Rdata")

load("Rdata/out_cci.Rdata")

load("Rdata/reproducibility_intra.Rdata")
load("Rdata/reproducibility_inter.Rdata")
load("Rdata/reproducibility_unref.Rdata")

```

```{r excluded_spectra}

# This chunk flags spectra with low reproducibility to be excluded
# in the metadata object

ls1 = sort(reproducibility_intra$spectrum[reproducibility_intra$exclude  == T])
ls2 = sort(reproducibility_inter$spectrum[reproducibility_inter$exclude  == T])
ls = unique(c(ls1, ls2))

metadata$excluded = ifelse(metadata$spectrum.id %in% ls, TRUE, FALSE)
summary(metadata$excluded)

```

# Make the reference MSL excluding spectra with low reproducibility

```{r reference_msl_sensitivity}

f_name = "Rdata/msl_ref_sensitivity.RDS"

if(MAKE_MSL | !file.exists(f_name)) {
  
  # Load the msl of processed spectra
  
  msl = readRDS("Rdata/msl_processed.RDS")
  
  # List mass spectra eventually included in the reference MSL
  
  ls_spectra_included = metadata$spectrum.id[metadata$panel == "reference"]
  ls_spectra_excluded = metadata$spectrum.id[metadata$panel == "reference" & metadata$excluded == TRUE]

  # Subset the msl object
  
  msl = msl[names(msl) %in% ls_spectra_included]
  msl = msl[!names(msl) %in% ls_spectra_excluded]

  # Save the reference MSL
  
  saveRDS(msl, file = f_name)

} else {
  
  msl_test = readRDS(f_name)

}

```

# Queries of the validation panel against the reference MSL

```{r match_val_noself}

f_name = "Rdata/match_val_noself_sensitivity.Rdata"

if(PANEL_TO_BANK | !file.exists(f_name)) {
  
  # List spectra included in the validation panel
  
  ls1 = metadata$spectrum.id[metadata$panel == "test"]
  
  # List spectra included in the reference MSL
  
  ls2 = metadata$spectrum.id[metadata$panel == "reference" & metadata$excluded == FALSE]
  
  # Make a data frame of all pairwise comparisons
  
  output = expand.grid(ls1, ls2)
  
  names(output) = c("spectrum.in", "spectrum.out")
  
  output$spectrum.in = as.character(output$spectrum.in)
  output$spectrum.out = as.character(output$spectrum.out)
  
  # Add sample information
  
  output$sample.in = metadata$sample.id[match(output$spectrum.in, metadata$spectrum.id)]
  output$sample.out = metadata$sample.id[match(output$spectrum.out, metadata$spectrum.id)]
  
  output$species.in = taxonomy$reference.identification.result[match(output$sample.in, taxonomy$sample.id)]
  output$species.out = taxonomy$reference.identification.result[match(output$sample.out, taxonomy$sample.id)]
  
  # Remove comparisons of the same specimen
  
  output = output[output$sample.in != output$sample.out, ]
  
  # Add CCI value
  
  output$cci  = NA
  
  out_cci$tag = paste(out_cci$spectrum.in, out_cci$spectrum.out)
  output$tag = paste(output$spectrum.in, output$spectrum.out)
  output$cci[is.na(output$cci)] = out_cci$cci[match(output$tag[is.na(output$cci)], out_cci$tag)]
  output$tag = paste(output$spectrum.out, output$spectrum.in)
  output$cci[is.na(output$cci)] = out_cci$cci[match(output$tag[is.na(output$cci)], out_cci$tag)]
  
  # Create an empty data frame to store the results
  
  df = data.frame()
  
  # Loop over all spectrum in the validation panel
  
  for(i in ls1) {
    
    # Subset comparisons of the spectrum of interest
    
    temp = output[output$spectrum.in == i, ]
    
    # Select the match with the highest CCI value
    
    temp = temp[order(temp$cci, decreasing = T), ]
    temp = temp[1,]
    
    # Append the result to the empty data frame
    
    df = rbind(df, temp)
    
  }
  
  # Add the log10CCI value
  
  df$cci_log = log10(df$cci)
  
  # Save the output
  
  match_val_noself = df
  save(match_val_noself, file = f_name)
  
} else {
  
  load(f_name)
  
}

```

```{r match_val_unref}

f_name = "Rdata/match_val_unref_sensitivity.Rdata"

if(PANEL_TO_BANK | !file.exists(f_name)) {
  
  # List spectra included in the validation panel
  
  ls1 = metadata$spectrum.id[metadata$panel == "test"]
  
  # List spectra included in the reference MSL
  
  ls2 = metadata$spectrum.id[metadata$panel == "reference" & metadata$excluded == FALSE]
  
  # Make a data frame of all pairwise comparisons
  
  output = expand.grid(ls1, ls2)
  
  names(output) = c("spectrum.in", "spectrum.out")
  
  output$spectrum.in = as.character(output$spectrum.in)
  output$spectrum.out = as.character(output$spectrum.out)
  
  # Add sample information
  
  output$sample.in = metadata$sample.id[match(output$spectrum.in, metadata$spectrum.id)]
  output$sample.out = metadata$sample.id[match(output$spectrum.out, metadata$spectrum.id)]
  
  output$species.in = taxonomy$reference.identification.result[match(output$sample.in, taxonomy$sample.id)]
  output$species.out = taxonomy$reference.identification.result[match(output$sample.out, taxonomy$sample.id)]
  
  # Remove comparisons of the same specimen
  
  output = output[output$species.in != output$species.out, ]
  
  # Add CCI value
  
  output$cci  = NA
  
  out_cci$tag = paste(out_cci$spectrum.in, out_cci$spectrum.out)
  output$tag = paste(output$spectrum.in, output$spectrum.out)
  output$cci[is.na(output$cci)] = out_cci$cci[match(output$tag[is.na(output$cci)], out_cci$tag)]
  output$tag = paste(output$spectrum.out, output$spectrum.in)
  output$cci[is.na(output$cci)] = out_cci$cci[match(output$tag[is.na(output$cci)], out_cci$tag)]
  
  # Create an empty data frame to store the results
  
  df = data.frame()
  
  # Loop over all spectrum in the validation panel
  
  for(i in ls1) {
    
    # Subset comparisons of the spectrum of interest
    
    temp = output[output$spectrum.in == i, ]
    
    # Select the match with the highest CCI value
    
    temp = temp[order(temp$cci, decreasing = T), ]
    temp = temp[1,]
    
    # Append the result to the empty data frame
    
    df = rbind(df, temp)
    
  }
  
  # Add the log10CCI value
  
  df$cci_log = log10(df$cci)
  
  # Save the output
  
  match_val_unref = df
  save(match_val_unref, file = f_name)
  
} else {
  
  load(f_name)
  
}

```

# Simulation experiments

```{r simulation_experiment}

f_name = "Rdata/out_sim_v2b_sensitivity.Rdata"

if (RUN_SIM | !file.exists(f_name)) {
  
  # List samples included in the validation panel
  
  ls_samples_val = sort(unique(metadata$sample.id[metadata$panel == "test"]))
  
  # Declare the number of trials and spots for the simulation
  
  n_trials = 1000
  n_spots = 9
  
  # Create an emtpyt data frame to store the results
  
  out_sim = data.frame()
  
  # Loop over the number of spots
  
  for (i in 1:n_spots){
    
    df1 = data.frame()
    
    # Loop over the number of trials
    
    for(j in 1:n_trials) {
      
      # Set new random seed for each trial
      
      set.seed(j)
      
      # Create an empty object to store the randomly selected spectra
      
      ls_spectra_sim = NULL
      
      # Loop over the list of samples included in the validation panel
      
      for(k in ls_samples_val) {
        
        # Select at random a specified number of spots for that sample
        
        temp = sample(metadata$spectrum.id[metadata$sample.id == k], i, replace = F)
        
        # Store the results in ls_spectra_sim
        
        ls_spectra_sim = c(ls_spectra_sim, temp)
        
      }
      
      # Create an empty data frame to store the results
      
      df2 = data.frame()
      
      # Loop over the list of samples included in the validation panel
      
      for (l in ls_samples_val) {
        
        # Select the matches of the selected spots
        
        temp = match_val_noself[match_val_noself$sample.in == l & match_val_noself$spectrum.in %in% ls_spectra_sim, ]
        
        # Keep only the best match
        
        temp = temp[order(temp$cci,decreasing = T), ]
        temp = temp[1,]
        
        # Store the result in df2
        
        df2 = rbind(df2, temp)
        
      }
      
      # Add the trial and spot number
      
      df2$trial = j
      df2$spots = i
      
      # Store the result in df1
      
      df1 = rbind(df1, df2)
      
    }
    
    # Store the result in out_sim
    
    out_sim = rbind(out_sim, df1)
    
  }
  
  # Transform the CCI value on the log scale
  
  out_sim$cci_log = log10(out_sim$cci)
  
  # Save the output
  
  out_sim_v2b = out_sim
  save(out_sim_v2b, file = f_name)
  
} else {
  
  load(f_name)
  
}

```

```{r simulation_experiment_unref}

f_name = "Rdata/out_sim_unref_v2b_sensitivity.Rdata"

if (RUN_SIM | !file.exists(f_name)) {
  
  # List samples included in the validation panel
  
  ls_samples_val = sort(unique(metadata$sample.id[metadata$panel == "test"]))
  
  # Declare the number of trials and spots for the simulation
  
  n_trials = 1000
  n_spots = 9
  
  # Create an emtpyt data frame to store the results
  
  out_sim = data.frame()
  
  # Loop over the number of spots
  
  for (i in 1:n_spots){
    
    df1 = data.frame()
    
    # Loop over the number of trials
    
    for(j in 1:n_trials) {
      
      # Set new random seed for each trial
      
      set.seed(j)
      
      # Create an empty object to store the randomly selected spectra
      
      ls_spectra_sim = NULL
      
      # Loop over the list of samples included in the validation panel
      
      for(k in ls_samples_val) {
        
        # Select at random a specified number of spots for that sample
        
        temp = sample(metadata$spectrum.id[metadata$sample.id == k], i, replace = F)
        
        # Store the results in ls_spectra_sim
        
        ls_spectra_sim = c(ls_spectra_sim, temp)
        
      }
      
      # Create an empty data frame to store the results
      
      df2 = data.frame()
      
      # Loop over the list of samples included in the validation panel
      
      for (l in ls_samples_val) {
        
        # Select the matches of the selected spots
        
        temp = match_val_unref[match_val_unref$sample.in == l & match_val_unref$spectrum.in %in% ls_spectra_sim, ]
        
        # Keep only the best match
        
        temp = temp[order(temp$cci,decreasing = T), ]
        temp = temp[1,]
        
        # Store the result in df2
        
        df2 = rbind(df2, temp)
        
      }
      
      # Add the trial and spot number
      
      df2$trial = j
      df2$spots = i
      
      # Store the result in df1
      
      df1 = rbind(df1, df2)
      
    }
    
    # Store the result in out_sim
    
    out_sim = rbind(out_sim, df1)
    
  }
  
  # Transform the CCI value on the log scale
  
  out_sim$cci_log = log10(out_sim$cci)
  
  # Save the output
  
  out_sim_unref_v2b = out_sim
  save(out_sim_unref_v2b, file = f_name)
  
} else {
  
  load(f_name)
  
}

```

# Evaluation of the performance

```{r}

# List unreferenced species

ls_samples_msl = sort(unique(metadata$sample.id[metadata$panel == 'reference' & metadata$excluded == FALSE]))
ls1 = sort(unique(taxonomy$reference.identification.result[taxonomy$sample.id %in% ls_samples_msl]))
ls2 = sort(unique(taxonomy$reference.identification.result[taxonomy$panel == 'test']))
ls_taxa_unref = ls2[!ls2 %in% ls1]

# Declare the range of threshold values to be assessed

ls_threshold = seq(-20, 0, 0.5)

# Declare input data

out_sim = out_sim_v2b

# Make an empty data frame to store the results

output = data.frame()

# Loop over threshold values

for (i in ls_threshold) {
  
  # True positive (concordant matches with CCI above the threshold)
  
  out_sim$result[out_sim$species.in == out_sim$species.out & out_sim$cci_log >= i] = "TP"
  
  # False positive (mismatches with CCI above the threshold)
  
  out_sim$result[out_sim$species.in != out_sim$species.out & out_sim$cci_log >= i] = "FP"
  
  # True negative (species not referenced in the MSL with CCI below the threshold)
  
  out_sim$result[(out_sim$species.in %in% ls_taxa_unref) & out_sim$cci_log < i] = "TN"
  
  # False negative (species referenced in the MSL with CCI below the threshold)
  
  out_sim$result[!(out_sim$species.in %in% ls_taxa_unref) & out_sim$cci_log < i] = "FN"
  
  # Sensitivity
  
  res = tapply(out_sim$result, list(out_sim$spots, out_sim$trial), FUN = function(x)(length(x[x=="TP"]) / length(x[x=="TP" | x == "FN"])))
  sensitivity = apply(res, 1 , median)
  sensitivity_lower = apply(res, 1 , quantile, probs = 0.025)
  sensitivity_upper = apply(res, 1 , quantile, probs = 0.975)
  
  # Positive predicitve value
  
  res = tapply(out_sim$result, list(out_sim$spots, out_sim$trial), FUN = function(x)(length(x[x=="TP"]) / length(x[x=="TP" | x == "FP"])))
  ppv = apply(res, 1 , median)
  ppv_lower = apply(res, 1 , quantile, probs = 0.025, na.rm = T)
  ppv_upper = apply(res, 1 , quantile, probs = 0.975, na.rm = T)
  
  # Accuracy
  
  res = tapply(out_sim$result, list(out_sim$spots, out_sim$trial), FUN = function(x)(length(x[x=="TN"|x=="TP"]) / length(x)))
  accuracy = apply(res, 1 , median)
  accuracy_lower = apply(res, 1 , quantile, probs = 0.025)
  accuracy_upper = apply(res, 1 , quantile, probs = 0.975)
  
  # Combine the results
  
  df = cbind(rep(i, 9), 1:9, sensitivity, sensitivity_lower, sensitivity_upper, ppv, ppv_lower, ppv_upper, accuracy, accuracy_lower, accuracy_upper)
  
  # Add results to output table
  
  output = rbind(output, df)
  
}

# Rename variables

names(output) = c("threshold", "spot", "sensitivity", "sensitivity.lower", "sensitivity.upper", "ppv", "ppv.lower", "ppv.upper", "accuracy", "accuracy.lower", "accuracy.upper")

# Store output

output1 = output

# Declare input data

out_sim = out_sim_unref_v2b

# Make an empty data frame to store the results

output = data.frame()

# Loop over threshold values

for (i in ls_threshold) {
  
  # False positive (mismatches with CCI above the threshold)
  
  out_sim$result[out_sim$cci_log >= i] = "FP"
  
  # True negative (species not referenced in the MSL with CCI below the threshold)
  
  out_sim$result[out_sim$cci_log < i] = "TN"
  
  # Specificity
  
  res = tapply(out_sim$result, list(out_sim$spots, out_sim$trial), FUN = function(x)(length(x[x=="TN"]) / length(x[x=="TN" | x == "FP"])))
  specificity = apply(res, 1 , median)
  specificity_lower = apply(res, 1 , quantile, probs = 0.025)
  specificity_upper = apply(res, 1 , quantile, probs = 0.975)
  
  # Accuracy
  
  res = tapply(out_sim$result, list(out_sim$spots, out_sim$trial), FUN = function(x)(length(x[x=="TN"|x=="TP"]) / length(x)))
  accuracy = apply(res, 1 , median)
  accuracy_lower = apply(res, 1 , quantile, probs = 0.025)
  accuracy_upper = apply(res, 1 , quantile, probs = 0.975)
  
  # False positive rate
  
  res = tapply(out_sim$result, list(out_sim$spots, out_sim$trial), FUN = function(x)(length(x[x=="FP"]) / length(x[x=="FP" | x == "TN"])))
  fpr = apply(res, 1 , median)
  fpr_lower = apply(res, 1 , quantile, probs = 0.025)
  fpr_upper = apply(res, 1 , quantile, probs = 0.975)
  
  # Combine the results
  
  df = cbind(rep(i, 9), 1:9, specificity, specificity_lower, specificity_upper, accuracy, accuracy_lower, accuracy_upper, fpr, fpr_lower, fpr_upper)
  
  # Add results to output table
  
  output = rbind(output, df)
  
}

# Rename variables

names(output) = c("threshold", "spot", "specificity", "specificity.lower",  "specificity.upper", "accuracy", "accuracy.lower", "accuracy.upper", "fpr", "fpr.lower", "fpr.upper")

# Store output

output2 = output

#################

output = data.frame(
  
  threshold = output1$threshold,
  spot = output1$spot,
  
  sensitivity = output1$sensitivity,
  sensitivity.lower = output1$sensitivity.lower,
  sensitivity.upper = output1$sensitivity.upper,
  
  specificity = output2$specificity,
  specificity.lower = output2$specificity.lower,
  specificity.upper = output2$specificity.upper,
  
  ppv = output1$ppv,
  ppv.lower = output1$ppv.lower,
  ppv.upper = output1$ppv.upper,
  
  accuracy = output1$accuracy,
  accuracy.lower = output1$accuracy.lower,
  accuracy.upper = output1$accuracy.upper,
  
  fpr = output2$fpr,
  fpr.lower = output2$fpr.lower,
  fpr.upper = output2$fpr.upper
  
)

```

```{r table_2_identification_performance}

# Reformat the results of performance evaluation at varying threshold

df = output

# Sensitivity

df$sensitivity2 = paste0(round(df$sensitivity, 2), " (", round(df$sensitivity.lower, 2), " to ", round(df$sensitivity.upper, 2), ")")

# Specificity

df$specificity2 = paste0(round(df$specificity, 2), " (", round(df$specificity.lower, 2), " to ", round(df$specificity.upper, 2), ")")

# Predictive positive value

df$ppv2 = paste0(round(df$ppv, 2), " (", round(df$ppv.lower, 2), " to ", round(df$ppv.upper, 2), ")")

# # Negative predictive value
# 
# df$npv2 = paste0(round(df$npv, 2), " (", round(df$npv.lower, 2), "; ", round(df$npv.upper, 2), ")")

# Accuracy

df$accuracy2 = paste0(round(df$accuracy, 2), " (", round(df$accuracy.lower, 2), " to ", round(df$accuracy.upper, 2), ")")

# Select varibales

# varsel = c("threshold", "spot", "sensitivity2", "specificity2", "ppv2", "npv2", "accuracy2")
varsel = c("threshold", "spot", "sensitivity2", "specificity2", "ppv2", "accuracy2")
df = df[,varsel]

# Save the formatted results

write.csv(df, file = "tables/table_S1_identification_performance_sensitivity.csv")

# Subset selected threshold values and numbers of spots 

df = df[(df$threshold == -14 & df$spot == 1) |
          (df$threshold == -14 & df$spot == 2) |
          (df$threshold == -14 & df$spot == 4) |
          (df$threshold == -14 & df$spot == 9) |
          (df$threshold == -13 & df$spot == 1) |
          (df$threshold == -13 & df$spot == 2) |
          (df$threshold == -13 & df$spot == 4) |
          (df$threshold == -13 & df$spot == 9) |
          (df$threshold == -12 & df$spot == 1) |
          (df$threshold == -12 & df$spot == 2) |
          (df$threshold == -12 & df$spot == 4) |
          (df$threshold == -12 & df$spot == 9) |
          (df$threshold == -11 & df$spot == 1) |
          (df$threshold == -11 & df$spot == 2) |
          (df$threshold == -11 & df$spot == 4) |
          (df$threshold == -11 & df$spot == 9) |
          (df$threshold == -10 & df$spot == 1) |
          (df$threshold == -10 & df$spot == 2) |
          (df$threshold == -10 & df$spot == 4) |
          (df$threshold == -10 & df$spot == 9), ]

# Display the results

knitr::kable(df, caption = "Table S1. Performance of Anopheles species identification with MALDI-TOF MS using the reference MSL excluding spectra with low reproducibility.")

```